generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AuthProvider {
  apple
  google
  phone
}

enum HouseholdRole {
  OWNER
  PARENT
  FAMILY_VIEWER
  CAREGIVER
}

enum MemberStatus {
  ACTIVE
  INVITED
  REMOVED
}

enum EventType {
  FORMULA
  BREASTFEED
  SLEEP
  PEE
  POO
  GROWTH
  MEMO
  SYMPTOM
  MEDICATION
}

enum EventSource {
  VOICE
  TEXT
  MANUAL
  IMPORT
}

enum EventStatus {
  OPEN
  CLOSED
  CANCELED
}

enum VoiceClipStatus {
  PARSED
  CONFIRMED
  FAILED
}

enum ReportPeriodType {
  DAILY
  WEEKLY
}

enum AiTone {
  FRIENDLY
  NEUTRAL
  FORMAL
  BRIEF
  COACH
}

enum PhotoVisibility {
  HOUSEHOLD
  BABY_SCOPED
}

enum SubscriptionPlan {
  PHOTO_SHARE
  AI_ONLY
  AI_PHOTO
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
}

enum ConsentType {
  TERMS
  PRIVACY
  DATA_PROCESSING
  COMMUNITY_UPLOAD
  AD_TARGETING
  LOCATION_BASED
  PHOTO_SHARE
}

model User {
  id              String             @id @default(uuid())
  provider        AuthProvider
  providerUid     String?
  phone           String?
  name            String
  createdAt       DateTime           @default(now())
  ownedHouseholds Household[]        @relation("HouseholdOwner")
  memberships     HouseholdMember[]
  consents        Consent[]
  personaProfile  PersonaProfile?
  aiToneProfile   AiToneProfile?
  eventsCreated   Event[]            @relation("EventCreator")
  invitesSent     Invite[]           @relation("InviteSender")
  photosUploaded  PhotoAsset[]       @relation("PhotoUploader")
  auditLogs       AuditLog[]         @relation("AuditActor")

  @@unique([provider, providerUid])
  @@unique([phone])
}

model Household {
  id             String           @id @default(uuid())
  ownerUserId    String
  createdAt      DateTime         @default(now())
  ownerUser      User             @relation("HouseholdOwner", fields: [ownerUserId], references: [id], onDelete: Restrict)
  members        HouseholdMember[]
  babies         Baby[]
  voiceClips     VoiceClip[]
  reports        Report[]
  albums         Album[]
  invites        Invite[]
  subscription   Subscription?
  auditLogs      AuditLog[]

  @@index([ownerUserId])
}

model HouseholdMember {
  id          String        @id @default(uuid())
  householdId String
  userId      String
  role        HouseholdRole
  status      MemberStatus  @default(ACTIVE)
  createdAt   DateTime      @default(now())
  household   Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
  @@index([householdId])
  @@index([userId])
}

model Baby {
  id          String   @id @default(uuid())
  householdId String
  name        String
  birthDate   DateTime
  sex         String?
  createdAt   DateTime @default(now())
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  events      Event[]
  voiceClips  VoiceClip[]
  reports     Report[]
  albums      Album[]

  @@index([householdId])
}

model Event {
  id           String      @id @default(uuid())
  babyId        String
  type          EventType
  startTime     DateTime
  endTime       DateTime?
  valueJson     Json
  metadataJson  Json?
  status        EventStatus @default(CLOSED)
  source        EventSource
  createdBy     String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now()) @updatedAt
  baby          Baby        @relation(fields: [babyId], references: [id], onDelete: Cascade)
  creator       User        @relation("EventCreator", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([babyId, startTime(sort: Desc)])
  @@index([babyId, type, startTime(sort: Desc)])
  @@index([babyId, status, startTime(sort: Desc)])
  @@index([babyId, type, status, startTime(sort: Desc)])
}

model VoiceClip {
  id               String         @id @default(uuid())
  householdId      String
  babyId           String
  audioUrl         String
  transcript       String?
  parsedEventsJson Json?
  confidenceJson   Json?
  status           VoiceClipStatus @default(PARSED)
  createdAt        DateTime       @default(now())
  household        Household      @relation(fields: [householdId], references: [id], onDelete: Cascade)
  baby             Baby           @relation(fields: [babyId], references: [id], onDelete: Cascade)

  @@index([householdId, createdAt(sort: Desc)])
}

model Report {
  id          String           @id @default(uuid())
  householdId String
  babyId      String
  periodType  ReportPeriodType
  periodStart DateTime
  periodEnd   DateTime
  metricsJson Json
  summaryText String
  modelVersion String
  createdAt   DateTime         @default(now())
  household   Household        @relation(fields: [householdId], references: [id], onDelete: Cascade)
  baby        Baby             @relation(fields: [babyId], references: [id], onDelete: Cascade)

  @@index([householdId, babyId, periodType, periodStart])
}

model PersonaProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  personaJson Json
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AiToneProfile {
  id               String   @id @default(uuid())
  userId           String   @unique
  tone             AiTone   @default(NEUTRAL)
  verbosityLevel   Int      @default(2)
  safetyStrictness Int      @default(2)
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Album {
  id          String   @id @default(uuid())
  householdId String
  babyId      String?
  title       String
  monthKey    String
  createdAt   DateTime @default(now())
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  baby        Baby?     @relation(fields: [babyId], references: [id], onDelete: SetNull)
  photos      PhotoAsset[]

  @@index([householdId, monthKey])
}

model PhotoAsset {
  id             String          @id @default(uuid())
  albumId        String
  uploaderUserId String
  variantsJson   Json
  visibility     PhotoVisibility @default(HOUSEHOLD)
  downloadable   Boolean         @default(false)
  createdAt      DateTime        @default(now())
  album          Album           @relation(fields: [albumId], references: [id], onDelete: Cascade)
  uploader       User            @relation("PhotoUploader", fields: [uploaderUserId], references: [id], onDelete: Restrict)

  @@index([albumId, createdAt(sort: Desc)])
}

model Invite {
  id          String        @id @default(uuid())
  householdId String
  token       String        @unique
  role        HouseholdRole
  expiresAt   DateTime
  invitedBy   String
  createdAt   DateTime      @default(now())
  usedAt      DateTime?
  household   Household     @relation(fields: [householdId], references: [id], onDelete: Cascade)
  sender      User          @relation("InviteSender", fields: [invitedBy], references: [id], onDelete: Restrict)

  @@index([householdId, expiresAt])
}

model Subscription {
  id          String              @id @default(uuid())
  householdId String              @unique
  plan        SubscriptionPlan
  status      SubscriptionStatus  @default(ACTIVE)
  renewAt     DateTime?
  createdAt   DateTime            @default(now())
  household   Household           @relation(fields: [householdId], references: [id], onDelete: Cascade)
}

model Consent {
  id         String      @id @default(uuid())
  userId     String
  type       ConsentType
  granted    Boolean
  grantedAt  DateTime    @default(now())
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, type])
}

model AuditLog {
  id         String   @id @default(uuid())
  householdId String
  actorUserId String?
  action     String
  targetType String
  targetId   String?
  payloadJson Json?
  createdAt  DateTime @default(now())
  household  Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  actor      User?     @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([householdId, createdAt(sort: Desc)])
}
